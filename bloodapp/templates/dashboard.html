{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Dashboard - LifeBlood Connect{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">



<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1>Welcome to Your Dashboard</h1>
        <p>Manage your blood donation activities and requests</p>
    </div>

    <!-- Main Actions Grid -->
    <div class="dashboard-grid">
        <!-- Donate Blood Card -->
        <div class="card">
            <div class="card-icon">ü©∏</div>
            <h3>Donate Blood</h3>
            <p>Help save lives by donating blood. Find nearby donation centers and schedule your donation appointment.</p>
            <button class="card-btn" onclick="openDonationForm()">Start Donation</button>
        </div>

        <!-- Request Blood Card -->
        <div class="card">
            <div class="card-icon">üè•</div>
            <h3>Request Blood</h3>
            <p>Need blood urgently? Submit a request to find compatible donors in your area quickly and safely.</p>
            <button class="card-btn" onclick="openBloodRequestForm()">Submit Request</button>
        </div>

        <!-- Find Donation Centers Card -->
        <div class="card">
            <div class="card-icon">üìç</div>
            <h3>Donation Centers</h3>
            <p>Locate blood donation centers near you with complete information about hours and available services.</p>
            <button class="card-btn" onclick="openDonationCenters()">View Centers</button>
        </div>

        <!-- My Donations Card -->
        <div class="card">
            <div class="card-icon">üìã</div>
            <h3>My Donations</h3>
            <p>Track your donation history, view certificates, and monitor your eligibility for future donations.</p>
            <a href="#" class="card-btn card-btn-secondary">View History</a>
        </div>

        <!-- Blood Inventory Card -->
        <div class="card">
            <div class="card-icon">üî¥</div>
            <h3>Blood Inventory</h3>
            <p>Check real-time blood stock availability by type and find the nearest centers with your required blood type.</p>
            <a href="#" class="card-btn card-btn-secondary">Check Stock</a>
        </div>

        <!-- My Profile Card -->
        <div class="card">
            <div class="card-icon">üë§</div>
            <h3>My Profile</h3>
            <p>Manage your personal information, blood type, medical history, and donation preferences.</p>
            <a href="#" class="card-btn card-btn-secondary">Edit Profile</a>
        </div>
    </div>

    <!-- Statistics Section -->
    <div class="stats-section">
        <h2 class="stats-title">Quick Statistics</h2>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">{{ stats.total_donations }}</div>
                <div class="stat-label">Total Donations</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ stats.total_donations|multiply:3 }}</div>
                <div class="stat-label">Lives Saved</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ stats.blood_requests }}</div>
                <div class="stat-label">Pending Requests</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ stats.total_donations|multiply:7 }}</div>
                <div class="stat-label">Points Earned</div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Section -->
    <div class="recent-section">
        <h2 class="recent-title">Recent Activity</h2>
        <ul class="activity-list">
            <li class="activity-item">
                <div>
                    <div class="activity-text">Blood donation completed</div>
                    <div class="activity-date">January 10, 2026</div>
                </div>
                <span class="activity-badge approved">Approved</span>
            </li>
            <li class="activity-item">
                <div>
                    <div class="activity-text">Blood request submitted for Type O+</div>
                    <div class="activity-date">January 8, 2026</div>
                </div>
                <span class="activity-badge pending">Pending</span>
            </li>
            <li class="activity-item">
                <div>
                    <div class="activity-text">Appointment scheduled at Central Blood Bank</div>
                    <div class="activity-date">January 5, 2026</div>
                </div>
                <span class="activity-badge approved">Scheduled</span>
            </li>
            <li class="activity-item">
                <div>
                    <div class="activity-text">Profile information updated</div>
                    <div class="activity-date">December 28, 2025</div>
                </div>
                <span class="activity-badge approved">Updated</span>
            </li>
            <li class="activity-item">
                <div>
                    <div class="activity-text">Blood donation completed</div>
                    <div class="activity-date">December 20, 2025</div>
                </div>
                <span class="activity-badge approved">Approved</span>
            </li>
        </ul>
    </div>
</div>

<!-- Donation Form Modal -->
<div id="donationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Blood Donation Registration</h2>
            <button class="close-btn" onclick="closeDonationForm()">&times;</button>
        </div>

        <div class="form-info">
            <strong>üìã Important:</strong> Please fill in all required fields accurately. Your information will be kept confidential.
        </div>

        <form id="donationForm">
            <!-- Personal Information Section -->
            <div class="form-row full">
                <label><strong>Personal Information</strong></label>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="aadhar">Aadhar Number <span class="required">*</span></label>
                    <input type="text" id="aadhar" name="aadhar" placeholder="XXXX XXXX XXXX XXXX" required>
                </div>
                <div class="form-group">
                    <label for="name">Full Name <span class="required">*</span></label>
                    <input type="text" id="name" name="name" placeholder="Enter your full name" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email Address <span class="required">*</span></label>
                    <input type="email" id="email" name="email" placeholder="your.email@example.com" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number <span class="required">*</span></label>
                    <input type="tel" id="phone" name="phone" placeholder="98XXXXXXXXXX" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="gender">Gender <span class="required">*</span></label>
                    <select id="gender" name="gender" required>
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dob">Date of Birth <span class="required">*</span></label>
                    <input type="date" id="dob" name="dob" required>
                </div>
            </div>

            <!-- Medical Information Section -->
            <div class="form-row full" style="margin-top: 25px;">
                <label><strong>Medical Information</strong></label>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="bloodGroup">Blood Group <span class="required">*</span></label>
                    <select id="bloodGroup" name="bloodGroup" required>
                        <option value="">Select Blood Group</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="weight">Weight (kg) <span class="required">*</span></label>
                    <input type="number" id="weight" name="weight" placeholder="Enter weight in kg" min="45" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" name="height" placeholder="Enter height in cm">
                </div>
                <div class="form-group">
                    <label for="lastDonation">Last Donation Date</label>
                    <input type="date" id="lastDonation" name="lastDonation">
                </div>
            </div>

            <!-- Health Information Section -->
            <div class="form-row full" style="margin-top: 25px;">
                <label><strong>Health Status</strong></label>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="noDisease" name="noDisease" required>
                    <label for="noDisease">I confirm that I do not have any chronic diseases or medical conditions <span class="required">*</span></label>
                </div>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="noMedication" name="noMedication">
                    <label for="noMedication">I am not currently on any antibiotics or medications</label>
                </div>
            </div>

            <!-- Address Information Section -->
            <div class="form-row full" style="margin-top: 25px;">
                <label><strong>Address Information</strong></label>
            </div>

            <div class="form-group">
                <label for="address">Street Address <span class="required">*</span></label>
                <input type="text" id="address" name="address" placeholder="Enter your street address" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="city">City <span class="required">*</span></label>
                    <input type="text" id="city" name="city" placeholder="Enter city" required>
                </div>
                <div class="form-group">
                    <label for="state">State <span class="required">*</span></label>
                    <input type="text" id="state" name="state" placeholder="Enter state" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="pincode">Pincode <span class="required">*</span></label>
                    <input type="text" id="pincode" name="pincode" placeholder="Enter pincode" required>
                </div>
                <div class="form-group">
                    <label for="country">Country <span class="required">*</span></label>
                    <input type="text" id="country" name="country" placeholder="India" value="India" required>
                </div>
            </div>

            <!-- Additional Information -->
            <div class="form-group" style="margin-top: 25px;">
                <label for="additionalInfo">Additional Information / Medical Notes</label>
                <textarea id="additionalInfo" name="additionalInfo" placeholder="Any allergies, past surgeries, or other relevant medical information..."></textarea>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeDonationForm()">Cancel</button>
                <button type="submit" class="btn-submit">Submit Registration</button>
            </div>
        </form>
    </div>
</div>



<!-- Blood Request Form Modal -->
<div id="bloodRequestModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Blood Request Form</h2>
            <button class="close-btn" onclick="closeBloodRequestForm()">&times;</button>
        </div>

        <div class="form-info">
            <strong>üìã Important:</strong> Please provide accurate information to help us find suitable donors for you quickly.
        </div>

        <form id="bloodRequestForm">
            <!-- Personal Information Section -->
            <div class="form-row full">
                <label><strong>Requester Information</strong></label>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="reqName">Full Name <span class="required">*</span></label>
                    <input type="text" id="reqName" name="name" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="reqContact">Contact Number <span class="required">*</span></label>
                    <input type="tel" id="reqContact" name="contactNo" placeholder="98XXXXXXXXXX" required>
                </div>
            </div>

            <div class="form-group">
                <label for="reqAddress">Address <span class="required">*</span></label>
                <input type="text" id="reqAddress" name="address" placeholder="Enter your address" required>
            </div>

            <!-- Blood Request Section -->
            <div class="form-row full" style="margin-top: 25px;">
                <label><strong>Blood Request Details</strong></label>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="reqBloodGroup">Blood Group Needed <span class="required">*</span></label>
                    <select id="reqBloodGroup" name="bloodGroup" required>
                        <option value="">Select Blood Group</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reqUnits">Units Required <span class="required">*</span></label>
                    <input type="number" id="reqUnits" name="unitsRequired" placeholder="Number of units needed" min="1" max="20" required>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="closeBloodRequestForm()">Cancel</button>
                <button type="submit" class="btn-submit">Submit Request</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Consolidated Form Handler
    function toggleModal(modalId, show) {
        const modal = document.getElementById(modalId);
        if (show) {
            modal.style.display = "block";
            document.body.style.overflow = "hidden";
        } else {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
            const form = modal.querySelector('form');
            if (form) form.reset();
        }
    }

    function openDonationForm() { toggleModal("donationModal", true); }
    function closeDonationForm() { toggleModal("donationModal", false); }
    function openBloodRequestForm() { toggleModal("bloodRequestModal", true); }
    function closeBloodRequestForm() { toggleModal("bloodRequestModal", false); }
    function openDonationCenters() { toggleModal("centersModal", true); }
    function closeDonationCenters() { toggleModal("centersModal", false); }

    // Generic Form Submission
    function submitForm(event, apiEndpoint) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData);
        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        fetch(apiEndpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(data => {
            alert((data.success ? '‚úÖ ' : '‚ùå Error: ') + data.message);
            if (data.success) {
                const modalId = event.target.closest('.modal').id;
                toggleModal(modalId, false);
                setTimeout(() => location.reload(), 2000);
            }
        })
        .catch(e => alert('‚ùå An error occurred. Please try again.'))
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    }

    // Input Formatting
    function formatAadhar(e) {
        e.target.value = e.target.value.replace(/\s/g, '').substring(0, 12).replace(/(\d{4})(?=\d)/g, '$1 ');
    }

    function formatPhone(e) {
        e.target.value = e.target.value.replace(/\D/g, '').substring(0, 10);
    }

    function filterCenters() {
        const search = document.getElementById("centerSearch").value.toLowerCase();
        document.querySelectorAll(".center-item").forEach(item => {
            item.style.display = item.textContent.toLowerCase().includes(search) ? "" : "none";
        });
    }

    // Close modals on outside click
    window.onclick = e => {
        if (e.target.classList.contains('modal')) {
            const modalId = e.target.id;
            toggleModal(modalId, false);
        }
    };

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', () => {
        const aadharInput = document.getElementById("aadhar");
        const phoneInput = document.getElementById("phone");
        const reqPhoneInput = document.getElementById("reqContact");
        const donationForm = document.getElementById("donationForm");
        const bloodRequestForm = document.getElementById("bloodRequestForm");

        if (aadharInput) aadharInput.addEventListener("input", formatAadhar);
        if (phoneInput) phoneInput.addEventListener("input", formatPhone);
        if (reqPhoneInput) reqPhoneInput.addEventListener("input", formatPhone);
        if (donationForm) donationForm.onsubmit = e => submitForm(e, '/api/register-donor/');
        if (bloodRequestForm) bloodRequestForm.onsubmit = e => submitForm(e, '/api/request-blood/');
    });
</script>

<!-- Donation Centers Modal -->
<div id="centersModal" class="modal">
    <div class="modal-content" style="max-width: 800px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h2>üè• Blood Donation Centers</h2>
            <button class="close-btn" onclick="closeDonationCenters()">&times;</button>
        </div>

        <div class="search-centers" style="padding: 0 40px;">
            <input type="text" id="centerSearch" placeholder="Search by city..." onkeyup="filterCenters()">
        </div>

        <div class="centers-container" id="centersList">
            {% for center in centers %}
            <div class="center-item">
                <div class="center-name">ü©∏ {{ center.name }}</div>
                <div class="center-detail">
                    <strong>üìç City:</strong> {{ center.city }}
                </div>
                <div class="center-detail">
                    <strong>üìû Phone:</strong> {{ center.phone }}
                </div>
                <div class="center-detail">
                    <strong>üìß Email:</strong> {{ center.email }}
                </div>
                <div class="center-hours">‚è∞ Hours: {{ center.opening_time|time:"g:i A" }} - {{ center.closing_time|time:"g:i A" }}</div>
                <div class="center-services">
                    <strong>Services:</strong><br>
                    {% for service in center.get_services_list %}
                        <span class="service-badge">{{ service }}</span>
                    {% endfor %}
                </div>
            </div>
            {% empty %}
            <div class="center-item">
                <p style="text-align: center; color: #6b7280;">No donation centers available at the moment.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}